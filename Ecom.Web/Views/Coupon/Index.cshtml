@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Coupon";
}

<h3>Coupon List</h3>
<hr />
<p>
    <button onclick="addCoupon()" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add Coupon </button>
</p>
<div id="loadingSpinner" style="display:none;">
    <p>Loading...</p>
</div>
<div id="couponList"></div>

<div class="modal fade" id="couponModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Add New Coupon</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="couponCreateModal"> </div>
        </div>
    </div>
</div>

@section Scripts {

    <script type="">
          $(document).ready(function() {
         getCouponList();
        });

        //List
                 function getCouponList() {
            $.ajax({
                url: '/Coupon/_getCouponList',
                type: 'GET',
                beforeSend: function () {
                    $("#loadingSpinner").show();
                },

                success: function (result) {
                    $("#couponList").html(result);
                },

                error: function (xhr, status, error) {
                    Swal.fire("Error loading coupons", error, "error");
                },
                complete: function () {
                    $("#loadingSpinner").hide();
                }
            });
        }

            //Create
        function addCoupon()
        {
          upSertCoupon(0);
        }

        //Update
        function updateCoupon(couponId)
        {
             upSertCoupon(couponId);
        }

        //Upsert
            function upSertCoupon(couponId) {
            $.ajax({
                url: '/Coupon/_UpsertCoupon',
                type: 'GET',
                    data: { couponId: couponId },
                success: function (html) {
                    $("#couponCreateModal").html(html);
                    $("#couponModal").modal("show");

                    // submit
                    $("#createCouponForm").on("submit", function (e) {
                        e.preventDefault();
                        var formData = $('#createCouponForm').serialize();
                        $.ajax({
                            url: '/Coupon/DoUpsert',
                            type: 'POST',
                            data: formData,
                            success: function (result) {
                                if (result != null) {
                                    showSuccessAlert()
                                    $("#couponModal").modal("hide");
                                     getCouponList();

                                } else {
                                     showErrorAlert()
                                       $("#couponModal").modal("hide");
                                       getCouponList();
                                }
                            },
                            error: function (xhr, status, error) {
                                showErrorAlert()
                                 getCouponList();
                            }
                        });
                    });
                },
                error: function (xhr, status, error) {
                   showErrorAlert()
                }
            });
        }

        //Delete
               function deleteCoupon(couponId) {
          Swal.fire({
            title: "Are you sure you want to delete?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, delete it!"
          }).then((result) => {
            if (result.isConfirmed) {
              $.ajax({
                url: '/Coupon/DoDelete',
                data: {
                  couponId: couponId,
                },
                success: function (response) {
                  if (response != null) {
                                    showSuccessAlert()
                                      getCouponList();
                                } else {
                                     showErrorAlert()
                                       getCouponList();
                                  }
                },
                error: function (xhr, status, error) {
                  showErrorAlert()
                                       getCouponList();
                }
              });

            }
          });
        }


    </script>

}


